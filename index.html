<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –¥—É—ç–ª—è–Ω—Ç—ã - –ò–≥—Ä–∞ –¥–ª—è –¥–≤–æ–∏—Ö</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            background-color: #000033;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 1px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 1px),
                radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 1px);
            background-size: 100px 100px, 50px 50px, 25px 25px;
            background-position: 0 0, 20px 20px, 10px 10px;
        }
        
        #startScreen, #waitingScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
        
        #waitingScreen, #gameOverScreen {
            display: none;
        }
        
        h1 {
            font-size: 3em;
            color: #4af;
            text-shadow: 0 0 10px #4af;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #4af;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            background-color: #6cf;
            transform: scale(1.05);
        }
        
        #inviteLink {
            margin: 20px 0;
            padding: 10px;
            background-color: #222;
            color: #4af;
            border: 1px solid #4af;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            word-break: break-all;
            font-family: monospace;
        }
        
        #playerInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }
        
        #player1Score, #player2Score {
            font-size: 1.2em;
            margin: 5px 0;
        }
        
        #player1Score {
            color: #f44;
        }
        
        #player2Score {
            color: #4af;
        }
        
        #controlsInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 5;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .mobile-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
            justify-content: space-between;
            z-index: 5;
        }
        
        .mobile-btn {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        #leftBtn {
            margin-left: 20px;
        }
        
        #rightBtn {
            margin-right: 20px;
        }
        
        #fireBtn {
            position: absolute;
            bottom: 120px;
            right: 30px;
            width: 100px;
            height: 100px;
            background-color: rgba(255, 50, 50, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
            
            #fireBtn {
                display: flex;
            }
            
            #controlsInfo {
                display: none;
            }
        }
        
        .powerup {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .health-powerup {
            background-color: #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        
        .speed-powerup {
            background-color: #ff0;
            box-shadow: 0 0 10px #ff0;
        }
        
        .weapon-powerup {
            background-color: #f80;
            box-shadow: 0 0 10px #f80;
        }
        
        .explosion {
            position: absolute;
            border-radius: 50%;
            background-color: #ff0;
            box-shadow: 0 0 20px #f80;
            transform: scale(0);
            opacity: 1;
            animation: explode 0.5s forwards;
        }
        
        @keyframes explode {
            to {
                transform: scale(3);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="playerInfo">
            <div id="player1Score">–ò–≥—Ä–æ–∫ 1: 0</div>
            <div id="player2Score">–ò–≥—Ä–æ–∫ 2: 0</div>
        </div>
        
        <div id="controlsInfo">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –ü—Ä–æ–±–µ–ª –¥–ª—è —Å—Ç—Ä–µ–ª—å–±—ã<br>
            –¶–µ–ª—å: —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∫–æ—Ä–∞–±–ª—å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ 5 —Ä–∞–∑
        </div>
        
        <div class="mobile-controls">
            <div id="leftBtn" class="mobile-btn">‚Üê</div>
            <div id="rightBtn" class="mobile-btn">‚Üí</div>
        </div>
        <div id="fireBtn" class="mobile-btn">üî•</div>
        
        <div id="startScreen">
            <h1>–ö–û–°–ú–ò–ß–ï–°–ö–ò–ï –î–£–≠–õ–Ø–ù–¢–´</h1>
            <button id="createGameBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
            <button id="joinGameBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        
        <div id="waitingScreen">
            <h1>–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–ê</h1>
            <div id="inviteLink">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
            <button id="cancelWaitBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
        
        <div id="gameOverScreen">
            <h1 id="gameOverTitle">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h1>
            <div id="gameOverMessage"></div>
            <button id="playAgainBtn">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDv0p5tEeJtJd4J1QaQwQ7Xq3X9X9X9X9X",
            authDomain: "space-duel-game.firebaseapp.com",
            databaseURL: "https://space-duel-game-default-rtdb.firebaseio.com",
            projectId: "space-duel-game",
            storageBucket: "space-duel-game.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijk1234567890"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const waitingScreen = document.getElementById('waitingScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const cancelWaitBtn = document.getElementById('cancelWaitBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const inviteLink = document.getElementById('inviteLink');
        const player1ScoreEl = document.getElementById('player1Score');
        const player2ScoreEl = document.getElementById('player2Score');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const fireBtn = document.getElementById('fireBtn');
        
        // –†–∞–∑–º–µ—Ä—ã canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            phase: 'start', // start, waiting, playing, gameOver
            playerId: null,
            gameId: null,
            isHost: false,
            players: {},
            bullets: [],
            powerups: [],
            explosions: [],
            scores: { player1: 0, player2: 0 },
            lastUpdate: 0,
            gameStartTime: 0,
            keys: {},
            mobileControls: {
                left: false,
                right: false,
                fire: false
            }
        };
        
        // –†–∞–∑–º–µ—Ä—ã –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        const PLAYER_SIZE = 30;
        const BULLET_SIZE = 8;
        const POWERUP_SIZE = 20;
        
        // –§–∏–∑–∏–∫–∞ –∏–≥—Ä—ã
        const PLAYER_SPEED = 5;
        const BULLET_SPEED = 10;
        const POWERUP_SPAWN_RATE = 0.005;
        const POWERUP_DURATION = 10000; // 10 —Å–µ–∫—É–Ω–¥
        
        // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
        class Player {
            constructor(id, x, y, color, isHost) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.color = color;
                this.width = PLAYER_SIZE;
                this.height = PLAYER_SIZE;
                this.speed = PLAYER_SPEED;
                this.health = 100;
                this.isHost = isHost;
                this.powerups = {
                    speed: { active: false, endTime: 0 },
                    weapon: { active: false, endTime: 0 }
                };
                this.lastFireTime = 0;
                this.fireRate = 500; // –º—Å –º–µ–∂–¥—É –≤—ã—Å—Ç—Ä–µ–ª–∞–º–∏
            }
            
            update(keys) {
                // –î–≤–∏–∂–µ–Ω–∏–µ
                if (this.isHost ? keys.ArrowLeft : keys.KeyA) this.x -= this.speed;
                if (this.isHost ? keys.ArrowRight : keys.KeyD) this.x += this.speed;
                if (this.isHost ? keys.ArrowUp : keys.KeyW) this.y -= this.speed;
                if (this.isHost ? keys.ArrowDown : keys.KeyS) this.y += this.speed;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
                this.x = Math.max(0, Math.min(canvas.width - this.width, this.x));
                this.y = Math.max(0, Math.min(canvas.height - this.height, this.y));
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö powerups
                const now = Date.now();
                if (this.powerups.speed.active && now > this.powerups.speed.endTime) {
                    this.powerups.speed.active = false;
                    this.speed = PLAYER_SPEED;
                }
                
                if (this.powerups.weapon.active && now > this.powerups.weapon.endTime) {
                    this.powerups.weapon.active = false;
                    this.fireRate = 500;
                }
            }
            
            draw() {
                ctx.save();
                ctx.fillStyle = this.color;
                
                // –†–∏—Å—É–µ–º –∫–æ—Ä–∞–±–ª—å
                ctx.beginPath();
                ctx.moveTo(this.x + this.width/2, this.y);
                ctx.lineTo(this.x + this.width, this.y + this.height);
                ctx.lineTo(this.x, this.y + this.height);
                ctx.closePath();
                ctx.fill();
                
                // –†–∏—Å—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–¥–æ—Ä–æ–≤—å—è
                ctx.fillStyle = 'red';
                ctx.fillRect(this.x, this.y - 10, this.width * (this.health / 100), 5);
                
                // –†–∏—Å—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã powerups
                if (this.powerups.speed.active) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(this.x, this.y - 20, 5, 5);
                }
                
                if (this.powerups.weapon.active) {
                    ctx.fillStyle = 'orange';
                    ctx.fillRect(this.x + 10, this.y - 20, 5, 5);
                }
                
                ctx.restore();
            }
            
            fire() {
                const now = Date.now();
                if (now - this.lastFireTime < this.fireRate) return null;
                
                this.lastFireTime = now;
                
                return new Bullet(
                    this.x + this.width/2 - BULLET_SIZE/2,
                    this.y,
                    this.isHost ? 1 : -1,
                    this.id,
                    this.powerups.weapon.active ? 40 : 20 // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —É—Ä–æ–Ω —Å powerup
                );
            }
        }
        
        class Bullet {
            constructor(x, y, direction, ownerId, damage) {
                this.x = x;
                this.y = y;
                this.width = BULLET_SIZE;
                this.height = BULLET_SIZE;
                this.direction = direction; // 1 –¥–ª—è –∏–≥—Ä–æ–∫–∞ 1 (–≤–Ω–∏–∑), -1 –¥–ª—è –∏–≥—Ä–æ–∫–∞ 2 (–≤–≤–µ—Ä—Ö)
                this.speed = BULLET_SPEED;
                this.ownerId = ownerId;
                this.damage = damage;
            }
            
            update() {
                this.y += this.speed * this.direction;
                return this.y < 0 || this.y > canvas.height;
            }
            
            draw() {
                ctx.save();
                ctx.fillStyle = this.ownerId === 'player1' ? '#f44' : '#4af';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è —É—Å–∏–ª–µ–Ω–Ω—ã—Ö –ø—É–ª—å
                if (this.damage > 20) {
                    ctx.strokeStyle = 'orange';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.x - 1, this.y - 1, this.width + 2, this.height + 2);
                }
                
                ctx.restore();
            }
        }
        
        class Powerup {
            constructor(type, x, y) {
                this.type = type; // 'health', 'speed', 'weapon'
                this.x = x;
                this.y = y;
                this.width = POWERUP_SIZE;
                this.height = POWERUP_SIZE;
                this.collected = false;
            }
            
            draw() {
                ctx.save();
                
                switch (this.type) {
                    case 'health':
                        ctx.fillStyle = '#0f0';
                        break;
                    case 'speed':
                        ctx.fillStyle = '#ff0';
                        break;
                    case 'weapon':
                        ctx.fillStyle = '#f80';
                        break;
                }
                
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
                const pulse = Math.sin(Date.now() / 200) * 0.2 + 0.8;
                ctx.globalAlpha = pulse;
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width/2 * 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }
        
        class Explosion {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.size = size;
                this.startTime = Date.now();
                this.duration = 500;
            }
            
            draw() {
                const progress = (Date.now() - this.startTime) / this.duration;
                if (progress >= 1) return false;
                
                ctx.save();
                ctx.globalAlpha = 1 - progress;
                
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.size * progress * 3
                );
                gradient.addColorStop(0, 'yellow');
                gradient.addColorStop(0.5, 'orange');
                gradient.addColorStop(1, 'red');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * progress * 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                return true;
            }
        }
        
        // –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function spawnPowerup() {
            if (Math.random() < POWERUP_SPAWN_RATE) {
                const types = ['health', 'speed', 'weapon'];
                const type = types[Math.floor(Math.random() * types.length)];
                const x = Math.random() * (canvas.width - POWERUP_SIZE);
                const y = Math.random() * (canvas.height - POWERUP_SIZE);
                
                return new Powerup(type, x, y);
            }
            return null;
        }
        
        function checkCollisions() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –ø—É–ª—å —Å –∏–≥—Ä–æ–∫–∞–º–∏
            gameState.bullets.forEach((bullet, bulletIndex) => {
                Object.values(gameState.players).forEach(player => {
                    if (bullet.ownerId !== player.id && 
                        bullet.x < player.x + player.width &&
                        bullet.x + bullet.width > player.x &&
                        bullet.y < player.y + player.height &&
                        bullet.y + bullet.height > player.y) {
                        
                        // –ü–æ–ø–∞–¥–∞–Ω–∏–µ
                        player.health -= bullet.damage;
                        gameState.bullets.splice(bulletIndex, 1);
                        
                        // –°–æ–∑–¥–∞–µ–º –≤–∑—Ä—ã–≤
                        gameState.explosions.push(new Explosion(
                            bullet.x + bullet.width/2,
                            bullet.y + bullet.height/2,
                            10
                        ));
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ä—Ç–∏ –∏–≥—Ä–æ–∫–∞
                        if (player.health <= 0) {
                            player.health = 100;
                            if (player.id === 'player1') {
                                gameState.scores.player2++;
                                player2ScoreEl.textContent = `–ò–≥—Ä–æ–∫ 2: ${gameState.scores.player2}`;
                            } else {
                                gameState.scores.player1++;
                                player1ScoreEl.textContent = `–ò–≥—Ä–æ–∫ 1: ${gameState.scores.player1}`;
                            }
                            
                            // –ë–æ–ª—å—à–æ–π –≤–∑—Ä—ã–≤ –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏
                            gameState.explosions.push(new Explosion(
                                player.x + player.width/2,
                                player.y + player.height/2,
                                30
                            ));
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
                            if (gameState.scores.player1 >= 5 || gameState.scores.player2 >= 5) {
                                endGame();
                            }
                        }
                        
                        return;
                    }
                });
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤ —Å powerups
            gameState.powerups.forEach((powerup, powerupIndex) => {
                if (powerup.collected) return;
                
                Object.values(gameState.players).forEach(player => {
                    if (powerup.x < player.x + player.width &&
                        powerup.x + powerup.width > player.x &&
                        powerup.y < player.y + player.height &&
                        powerup.y + powerup.height > player.y) {
                        
                        powerup.collected = true;
                        applyPowerup(player, powerup.type);
                        gameState.powerups.splice(powerupIndex, 1);
                        return;
                    }
                });
            });
        }
        
        function applyPowerup(player, type) {
            const now = Date.now();
            
            switch (type) {
                case 'health':
                    player.health = Math.min(100, player.health + 30);
                    break;
                    
                case 'speed':
                    player.powerups.speed.active = true;
                    player.powerups.speed.endTime = now + POWERUP_DURATION;
                    player.speed = PLAYER_SPEED * 1.5;
                    break;
                    
                case 'weapon':
                    player.powerups.weapon.active = true;
                    player.powerups.weapon.endTime = now + POWERUP_DURATION;
                    player.fireRate = 200; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å
                    break;
            }
        }
        
        function updateGame() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
            Object.values(gameState.players).forEach(player => {
                player.update(gameState.keys);
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å
            gameState.bullets = gameState.bullets.filter(bullet => !bullet.update());
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∑—Ä—ã–≤–æ–≤
            gameState.explosions = gameState.explosions.filter(explosion => explosion.draw());
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
            checkCollisions();
            
            // –°–ø–∞–≤–Ω powerups
            const newPowerup = spawnPowerup();
            if (newPowerup) {
                gameState.powerups.push(newPowerup);
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
            if (gameState.isHost && Date.now() - gameState.lastUpdate > 100) {
                gameState.lastUpdate = Date.now();
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const syncData = {
                    players: gameState.players,
                    bullets: gameState.bullets,
                    powerups: gameState.powerups,
                    scores: gameState.scores,
                    timestamp: Date.now()
                };
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firebase
                database.ref(`games/${gameState.gameId}`).update(syncData);
            }
        }
        
        function drawGame() {
            // –û—á–∏—Å—Ç–∫–∞ canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –∑–≤–µ–∑–¥–Ω—ã–π —Ñ–æ–Ω
            drawStarfield();
            
            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–æ–≤
            Object.values(gameState.players).forEach(player => {
                player.draw();
            });
            
            // –†–∏—Å—É–µ–º –ø—É–ª–∏
            gameState.bullets.forEach(bullet => {
                bullet.draw();
            });
            
            // –†–∏—Å—É–µ–º powerups
            gameState.powerups.forEach(powerup => {
                if (!powerup.collected) {
                    powerup.draw();
                }
            });
            
            // –†–∏—Å—É–µ–º –≤–∑—Ä—ã–≤—ã (—É–∂–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ updateGame)
        }
        
        function drawStarfield() {
            ctx.save();
            ctx.fillStyle = 'white';
            
            // –°—Ç–∞—Ç–∏—á–Ω—ã–µ –∑–≤–µ–∑–¥—ã
            for (let i = 0; i < 100; i++) {
                const x = Math.sin(i * 100) * canvas.width/2 + canvas.width/2;
                const y = Math.cos(i * 100) * canvas.height/2 + canvas.height/2;
                const size = Math.random() * 1.5;
                
                ctx.globalAlpha = Math.random() * 0.8 + 0.2;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –î–≤–∏–∂—É—â–∏–µ—Å—è –∑–≤–µ–∑–¥—ã (–ø–∞—Ä–∞–ª–ª–∞–∫—Å —ç—Ñ—Ñ–µ–∫—Ç)
            const time = Date.now() / 1000;
            for (let i = 0; i < 50; i++) {
                const x = (Math.sin(time + i * 20) * canvas.width/2 + canvas.width/2);
                const y = (Math.cos(time + i * 20) * canvas.height/2 + canvas.height/2);
                const size = Math.random() * 2;
                
                ctx.globalAlpha = Math.random() * 0.5 + 0.5;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        function gameLoop() {
            if (gameState.phase === 'playing') {
                updateGame();
                drawGame();
            }
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            gameState.phase = 'playing';
            startScreen.style.display = 'none';
            waitingScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            gameState.bullets = [];
            gameState.powerups = [];
            gameState.explosions = [];
            
            if (gameState.isHost) {
                gameState.scores = { player1: 0, player2: 0 };
                player1ScoreEl.textContent = '–ò–≥—Ä–æ–∫ 1: 0';
                player2ScoreEl.textContent = '–ò–≥—Ä–æ–∫ 2: 0';
                
                // –°–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤
                gameState.players = {
                    player1: new Player('player1', canvas.width/2 - PLAYER_SIZE/2, 50, '#f44', true),
                    player2: new Player('player2', canvas.width/2 - PLAYER_SIZE/2, canvas.height - 50 - PLAYER_SIZE, '#4af', false)
                };
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –≤ Firebase
                database.ref(`games/${gameState.gameId}`).set({
                    players: gameState.players,
                    bullets: [],
                    powerups: [],
                    scores: { player1: 0, player2: 0 },
                    timestamp: Date.now()
                });
            }
        }
        
        function endGame() {
            gameState.phase = 'gameOver';
            
            const winner = gameState.scores.player1 >= 5 ? 'player1' : 'player2';
            const isLocalPlayerWinner = (winner === 'player1' && gameState.isHost) || 
                                      (winner === 'player2' && !gameState.isHost);
            
            gameOverTitle.textContent = isLocalPlayerWinner ? '–ü–û–ë–ï–î–ê!' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
            gameOverTitle.style.color = isLocalPlayerWinner ? '#4af' : '#f44';
            gameOverTitle.style.textShadow = `0 0 10px ${isLocalPlayerWinner ? '#4af' : '#f44'}`;
            
            gameOverMessage.textContent = `–°—á–µ—Ç: ${gameState.scores.player1} - ${gameState.scores.player2}`;
            gameOverScreen.style.display = 'flex';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
            if (!gameState.isHost) {
                database.ref(`games/${gameState.gameId}`).off();
            }
        }
        
        function createNewGame() {
            gameState.playerId = 'player' + Math.floor(Math.random() * 1000);
            gameState.gameId = 'game' + Date.now();
            gameState.isHost = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            const inviteUrl = `${window.location.origin}${window.location.pathname}?join=${gameState.gameId}`;
            inviteLink.textContent = inviteUrl;
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è
            gameState.phase = 'waiting';
            startScreen.style.display = 'none';
            waitingScreen.style.display = 'flex';
            
            // –°–ª—É—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            database.ref(`games/${gameState.gameId}/players/player2`).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    // –í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
                    gameState.players.player2 = new Player(
                        'player2', 
                        canvas.width/2 - PLAYER_SIZE/2, 
                        canvas.height - 50 - PLAYER_SIZE, 
                        '#4af', 
                        false
                    );
                    
                    startGame();
                }
            });
        }
        
        function joinGame(gameId) {
            gameState.playerId = 'player' + Math.floor(Math.random() * 1000);
            gameState.gameId = gameId;
            gameState.isHost = false;
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è
            gameState.phase = 'waiting';
            startScreen.style.display = 'none';
            waitingScreen.style.display = 'flex';
            inviteLink.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...';
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∏–≥—Ä–µ
            database.ref(`games/${gameId}`).on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    alert('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                    cancelWait();
                    return;
                }
                
                // –ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—Å—è –∫–∞–∫ –∏–≥—Ä–æ–∫ 2
                if (!data.players || !data.players.player2) {
                    database.ref(`games/${gameId}/players/player2`).set({
                        x: canvas.width/2 - PLAYER_SIZE/2,
                        y: canvas.height - 50 - PLAYER_SIZE,
                        health: 100
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                if (data.players) {
                    gameState.players = {
                        player1: new Player('player1', data.players.player1.x, data.players.player1.y, '#f44', false),
                        player2: new Player('player2', data.players.player2.x, data.players.player2.y, '#4af', false)
                    };
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
                    gameState.bullets = data.bullets ? data.bullets.map(b => new Bullet(b.x, b.y, b.direction, b.ownerId, b.damage)) : [];
                    gameState.powerups = data.powerups ? data.powerups.map(p => new Powerup(p.type, p.x, p.y)) : [];
                    gameState.scores = data.scores || { player1: 0, player2: 0 };
                    
                    player1ScoreEl.textContent = `–ò–≥—Ä–æ–∫ 1: ${gameState.scores.player1}`;
                    player2ScoreEl.textContent = `–ò–≥—Ä–æ–∫ 2: ${gameState.scores.player2}`;
                    
                    // –ï—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å, —Å—Ç–∞—Ä—Ç—É–µ–º
                    if (gameState.phase === 'waiting' && data.players.player1 && data.players.player2) {
                        startGame();
                    }
                }
            });
        }
        
        function cancelWait() {
            if (gameState.isHost) {
                database.ref(`games/${gameState.gameId}`).remove();
            } else {
                database.ref(`games/${gameState.gameId}/players/player2`).remove();
                database.ref(`games/${gameState.gameId}`).off();
            }
            
            gameState.phase = 'start';
            waitingScreen.style.display = 'none';
            startScreen.style.display = 'flex';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        createGameBtn.addEventListener('click', createNewGame);
        joinGameBtn.addEventListener('click', () => {
            const gameId = prompt('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã:');
            if (gameId) {
                joinGame(gameId);
            }
        });
        cancelWaitBtn.addEventListener('click', cancelWait);
        playAgainBtn.addEventListener('click', () => {
            if (gameState.isHost) {
                createNewGame();
            } else {
                joinGame(gameState.gameId);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        window.addEventListener('keydown', (e) => {
            gameState.keys[e.code] = true;
            
            // –°—Ç—Ä–µ–ª—å–±–∞
            if (gameState.phase === 'playing') {
                if ((e.code === 'Space' || e.code === 'KeyF') && gameState.playerId) {
                    const player = gameState.isHost ? gameState.players.player1 : gameState.players.player2;
                    const bullet = player.fire();
                    if (bullet) {
                        gameState.bullets.push(bullet);
                        
                        // –•–æ—Å—Ç —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—É–ª—é, –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                        if (gameState.isHost) {
                            database.ref(`games/${gameState.gameId}/bullets`).set(gameState.bullets);
                        } else {
                            database.ref(`games/${gameState.gameId}/bullets`).push({
                                x: bullet.x,
                                y: bullet.y,
                                direction: bullet.direction,
                                ownerId: bullet.ownerId,
                                damage: bullet.damage
                            });
                        }
                    }
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            gameState.keys[e.code] = false;
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.mobileControls.left = true;
            gameState.keys[gameState.isHost ? 'ArrowLeft' : 'KeyA'] = true;
        });
        
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.mobileControls.left = false;
            gameState.keys[gameState.isHost ? 'ArrowLeft' : 'KeyA'] = false;
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.mobileControls.right = true;
            gameState.keys[gameState.isHost ? 'ArrowRight' : 'KeyD'] = true;
        });
        
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.mobileControls.right = false;
            gameState.keys[gameState.isHost ? 'ArrowRight' : 'KeyD'] = false;
        });
        
        fireBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.mobileControls.fire = true;
            gameState.keys['Space'] = true;
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è —Å—Ç—Ä–µ–ª—å–±—ã
            if (gameState.phase === 'playing' && gameState.playerId) {
                const player = gameState.isHost ? gameState.players.player1 : gameState.players.player2;
                const bullet = player.fire();
                if (bullet) {
                    gameState.bullets.push(bullet);
                    
                    if (gameState.isHost) {
                        database.ref(`games/${gameState.gameId}/bullets`).set(gameState.bullets);
                    } else {
                        database.ref(`games/${gameState.gameId}/bullets`).push({
                            x: bullet.x,
                            y: bullet.y,
                            direction: bullet.direction,
                            ownerId: bullet.ownerId,
                            damage: bullet.damage
                        });
                    }
                }
            }
        });
        
        fireBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.mobileControls.fire = false;
            gameState.keys['Space'] = false;
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joinGameId = urlParams.get('join');
            
            if (joinGameId) {
                joinGame(joinGameId);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            gameLoop();
        });
    </script>
</body>
</html>
